//
//  main.swift
//  day13
//
//  Created by Mark Johnson on 12/13/18.
//  Copyright Â© 2018 matzsoft. All rights reserved.
//
// NOTE: In order to not make the input data less readable I have replaced all backslash characters with
// lower case b.

import Foundation

let input = """
                                           /-----------------------------------------------------------------b                                        
  /----------------------b/----------------+-------------------------------------------------------b    /----+----b                                   
  |                      ||                |   /----------------------------b                      |    | /--+----+---------------------------------b 
 /+----------b    /------++----------------+---+-----------b                |   /------------------+----+-+--+----+---------------------------b     | 
 ||          |    |/-----++----------------+---+-----------+--------b       |   |                  |    | |  |    |                           |     | 
 ||          |    ||     ||                |   |    /------+-------b|       |   |            /-----+----+b|  |    |                  /--------+----b| 
 ||          |    ||     ||         /------+---+----+------+-------++-------+---+------------+-----+----+++--+----+b                 |        |    || 
 ||     /----+----++--b  ||         |      |   |    |      |       ||     /-+---+------------+-----+----+++--+----++------b          |        |    || 
 ||     |    |    ||  |  ||         |      |   |    |      |       ||     | |   |            |     |    |||  |    ||      |          |        |    || 
 ||     |    |    ||  |  ||     /---+------+---+----+------+-------++-----+-+---+------------+-----+----+++--+----++------+-----b    |        |    || 
 ||     |    |    ||  | /++-----+---+--b   |   |    |      |       ||     | |   |            |     |    |||  |    ||      |     |    |        |    || 
 ||     |    |    ||  | |||     |   |  |   b---+----+------+-------++-----+-+---+------------+-----+----+++--/    ||      |     |    |        |    || 
 ||  /--+----+----++--+-+++-----+---+--+-------+----+------+------b||     | |   |         /--+-----+----+++-------++------+-----+----+--------+--b || 
 ||  |  |    |    ||  | |||     |   |  v       |    |      |      |||     | |   |         |  |     |    |||       ||      |     |    |        |  | || 
 ||  |  |/---+----++--+-+++-----+---+--+-------+----+------+------+++----b| |   |         |  |     |    |||       ||      |     |    b--------+--+-/| 
 b+--+--++---/    |b--+-+++-----+---+--+-------+----+------+------++/ /--++-+---+---------+--+---b |    |||       ||      |     |             |  |  | 
  |  |  ||        |   | |||     |   |  |       |    |   /--+------++--+--++-+---+------b  |  |   | |    |||       ||      |     |             |  |  | 
  |  |  ||        |/--+-+++-----+---+--+-------+----+---+--+---b  ||  |  || |   |      |  |  |   | |    |||       ||      |   /-+-------------+b |  | 
  |/-+--++--------++--+-+++-----+---+--+-------+----+---+--+--b|  ||  |  || |   |      |  |  |   | |    |||       ||      |   | |             || |  | 
  || |  ||        ||  | |||     |   |  |       |    b---+--+--++--+/  |  || |   b------+--+--+---+-+----+++-------++------+---+-+-------------/| |  | 
  || |  ||        ||  | |||/----+---+--+-------+--------+--+--++--+---+--++-+--->------+--+--+---+-+----+++-------++------+---+-+--b           | |  | 
  || |  ||        ||  | ||||    b---+--+-------+--------+--+--++--+---+--++-+----------+--+--+---+-+----+++-------++------+---+-/  |           | |  | 
  || |  ||        ||  | ||||        |  |   /--<+----b   |  |  ||  |   |  |b-+----------+--+--+---+-+----+++-------++------/   |    |           | |  | 
  || |  b+--------++--/ ||||        |  |   |  /+----+---+--+--++--+---+b |  |          |  |  |   | |    |||       ||          |    |           | |  | 
  || |   |/-------++----++++--------+--+---+--++---b|   |/-+--++--+---++-+--+--------b | /+--+---+-+----+++-------++----------+----+-----b     | |  | 
  || |   ||       ||    ||||        |  |   |  ||   ||/--++-+--++--+---++-+--+--------+-+-++--+---+-+----+++-------++----------+----+-----+-----+-+--+b
  || |   ||       ||    ||||        |  |   |  ||   |||  || |  ^|  |   || |  |        | | ||  |   | |    |||       ||          |    |     |     | |  ||
  || |   ||       ||    ||||       /+--+---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+---+-+----+++-------++----------+----+-----+---b | |  ||
  || |   ||       ||    ||||   /---++--+---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+---+-+----+++------b||          b----+-----+---+-/ |  ||
  || |   ||       ||    ||||   |/--++--+---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+---+-+----+++------+++---------------+---b |   |   |  ||
  || |   ||       ||    ||||   ||  || /+---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+---+-+----+++------+++---------------+---+-+---+-b |  ||
  b+-+---++-------++----+/||   ||  || ||   |  ||   |||  || |  ||  |   || |  |        | | ||  | /-+-+----+++------+++---------b     |   | |   | | |  ||
   | |   ||     /-++----+-++---++--++-++---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+-+-+-+b   |||      |||         |     |   | |   | | |  ||
   | |   ||/----+-++----+-++---++--++-++---+--++---+++--++-+--++--+---++-+--+--------+-+-++--+-+-+-++---+++----b |||         |     |   | |   | | |  ||
   | |   |||    | ||    | ||   ||  || ||   |  ||   |||  || |  ||  |   || |  |   /----+-+-++--+-+-+-++---+++----+-+++--b      |     |   | |   | | |  ||
   | |   |||    | ||    | ||   ||  || ||   |  |b---+++--++-+--++--+---++-+--/   | /--+-+-++-b| | | ||   |||    | |||  |      |     |   | |   | | |  ||
   | |   |||    | ||    | ||   ||  || ||   |  |    |||  || |/-++--+---++-+------+-+--+-+-++-++-+-+-++---+++----+-+++--+------+-----+---+-+b  | | |  ||
   | |   |||    | ||   /+-++---++--++-++---+--+----+++--++-++-++--+---++-+------+-+--+-+-++-++-+-+-++---+++-b  | |||  |      |     |   | ||  | | |  ||
  /+-+---+++----+-++---++-++---++--++-++---+--+-b  |||  || || ||  |   || |      | |  | | || || | | ||   ||| |  | |||  |      |     |   | ||  | | |  ||
  || |   |||    | ||   || ||   ||  || ||   |  | |  |||  || || ||  ^  /++-+------+-+--+-+-++-++-+-+-++--b||| |  | |||  |      |     |   | ||  | | |  ||
  || |   |||    | ||   || ||   ||  || ||/--+--+-+--+++--++-++-++--+--+++-+------+-+--+-+-++-++-+-+-++--++++-+-b| |||  |      |     |   | ||  | | |  ||
  || |   |||    | ||   || ||   ||  || |||  |/-+-+--+++--++-++-++--+--+++-+------+-+--+-+-++-++-+-+-++--++++-+-++-+++--+------+-----+---+-++-b| | |  ||
  || |   |||    | ||   || ||   ||  || |||  || | |  |||  |b-++-++--+--+++-+------+-+--/ | || || | | ||  |||| | || |||  |      |     |   | || || | |  ||
  || |   |||    | ||   || ||/--++--++-+++--++-+-+--+++--+--++-++--+--+++-+------+-+---b| || || | |/++--++++-+-++-+++--+------+---b | /-+-++-++-+-+-b||
  || |   |b+----+-++---++-+++--++--++-+++--++-+-+--/|| /+--++-++--+--+++-+------+-+--b|| || || | ||||  |||| | || |||  |      |   | | | | || || | | |||
/-++-+---+-+----+-++---++-+++--++--++-+++--++-+-+---++-++--++-++--+--+++-+------+-+--+++-++-++-+-++++-b|||| | || |||  |      |   | | | | || || | | |||
| || |   | |    | b+---++-+++--++--++-+++--++-+-+---++-++--/| ||  |  ||| |      | |  ||| || || | |||| ||||| | || |||  |      |   | | | | || || | | |||
| || |   | |    |  b---++-+++--++--++-+++--++-+-+---++-++---+-+/  |  ||| |      | |  ||| || || | |||| ||||| | || |||  |      |   | | | | || || | | |||
| || |   | |   /+------++-+++--++--++-+++--++-+-+---++-++---+-+--b|  |b+-+------+-+--+++-++-++-+-/||| ||||| | || |||  |      |   | | | | || || | | |||
| || |   | |   ||      || |||  ||  || |||  || | |   || ||   | |  ||  | | |      | |  ||| || |b-+--+++-+++/| | || |||  |      |   | | | | || || | | |||
| || |   | |   ||      || |||  ||  || |||  || | |   || ||   | |  ||  | | |      | |  ||| || |  |  ||| ||| | | || |||  |   /--+---+-+-+-+-++b|| | | |||
| || |   | |   ||  /---++-+++--++--++-+++--++-+-+---++-++---+-+--++b | | |     /+-+--+++b|| |  |  ||| ||| | | || |||  |/--+--+---+b| | | ||||| | | |||
| || |   | |   ||  |   || |||  ||  || ||| /++-+-+---++-++---+-+--+++-+-+-+-----++-+--++++++-+--+--+++-+++-+-+-++-+++--++--+--+b  ||| | | ||||| | | |||
| || |   | |   ||  |   || |||  ||/-++-+++-+++-+-+---++-++---+-+--+++-+-+-+-----++-+b |||||| |  |  ||| ||| b-+-++-+++--++--+--++--+++-+-+-+++++-+-+-+/|
| || |/--+-+---++--+---++-+++--+++-++-+++-+++-+-+---++-++---+-+--+++-+-+-+-----++-++-++++++-+-b|  ||| |||   | || |||  ||  |  ||  ||| | | ||||| | | | |
| || ||  | |   || /+---++-+++--+++-++-+++-+++-+-+---++-++---+-+--+++-+-+-+-----++-++-++++++-+-++--+++-+++-b | || |||  ||  |  ||  ||| | | ||||| | | | |
| || ||  | |   || ||   ||/+++--+++-++-+++-+++-+-+---++-++---+-+>-+++-+-+-+-----++-++-++++++-+-++--+++-+++-+-+-++-+++--++--+--++b ||| | | ||||| | | | |
| || ||  | |   || ||   ||||||  ||| || ||| |b+-+-+---/| ||   | |  ||| | | |     || || |||||| | ||  ||| ||| | | || |||  ||  |  ||| ||| | | ||||| | | | |
| || ||  | |   || ||   ||||||  |b+-++-+++-+-+-+-+----+-++---+-+--+++-+-+-+-----++-++-++++++-+-++--+++-+++-+-+-++-+++--++--+--+++-+++-+-/ ||||| | | | |
| || ||  | |   || ||   ||||||  | | || ||| | | | |    | ||   | |  ||| | | |     || || ||||||/+-++--+++-+++-+-+-++-+++--++b |  ||| ||| |   ||||| | | | |
| || ||  | |   || ||   ||||b+--+-+-++-+++-+-+-+-+----+-++---+-+--+++-+-+-+---->++-++-++++++++-++--+++-+++-+-+-++-+++--+++-+--+++-++/ |   ||||| | | | |
| || ||  | b---++-++---++++-+--+-+-++-+++-+-+-+-+----+-++---+-+--+++-+-+-+-----++-++-++++++++-++--+++-+++-+-+-+/ |||  ||| |  ||| ||  |   ||||| | | | |
| || ||  | /---++-++b  |||| |  | | || ||| | | | |    |/++---+-+--+++-+-+-+-----++-++-++++++++-++--+++-+++-+-+-+--+++--+++-+--+++-++--+---+++++b| | | |
| || ||  | |   || |b+--++++-+--+-+-++-+++-+-+-+-+----++++---+-+--++/ | | |     || || |||||||| ||  ||| ||| | | |  |||  ||| |  ||| ||  |   ||||||| | | |
| || ||  | |   || | |  |||| |  | | || ||| b-+-+-+----++++---+-+--++--+-+-+-----++-++-++++++++-++--+++-+++-+-+-+--+++--+++-+--+/| ||  |   ||||||| | | |
| || ||  | |   || | |  |||b-+--+-+-++-+++---+-+-+----++++---+-+--++--+-+-+-----++-++-++++++++-++--+/| ||| | v |  |||  ||| |  | | ||  |   ||||||| | | |
| || ||  | |   || | |  |||  |/-+-+-++-+++---+-+-+----++++---+-+--++--+b| |     || || |||||||| ||  | | ||| | | |  |||  ||| |  | | ||  |   ||||||| | | |
| || ||  | |   || | |  ||| /++-+-+-++-+++---+-+-+----++++---+-+b ||  ||| | /---++-++-++++++++-++--+-+-+++-+-+b|  |||  ||| |  | | ||  |   ||||||| | | |
| ||/++--+-+---++-+-+--+++-+++-+-+-++-+++---+-+-+----++++--b| || ||  ||| | |   || || |||||||| ||  | | ||| | |||  |||  ||| |  | | ||  |   ||||||| | | |
| |||||  | |   |b-+-+--+++-+++-+-+-++-+++---+-+-+----++++--++-++-++--+++-+-+---++-++-++++++++-++--+-/ ||| | |||  |||  ||| |  | | ||  |   ||||||| | | |
| |||||  | |   |  | |  ||| ||| | | || |||   | | |    ||||  || || ||  ||| | |   || || ||||b+++-++--+---+++-+-+++--+++--+++-+--+-+-++--+---/|||||| | | |
| |||||  | |   |  | |  ||| ||| | | || |||   | | |    ||b+--++-++-++--+++-+-+---++-++-/||| ||| |b--+---+++-+-+++--+++--+++-+--/ | ||  |    |||||| | | |
| |||||  | |   | /+-+--+++-+++-+-+-++-+++---+-+-+----++-+-b|| || ||  ||| | |   || ||  ||| ||| |   |   ||| | |||  |||  ||| |    | ||  |    |||||| | | |
| |||||  | |   | || |  ||| ||| | | || |||   | | |    || | ||| || ||  ||| | |   || ||  ||| ||| | /-+---+++-+-+++--+++--+++-+----+-++b b----++++++-+-/ |
| |||||  | |   | || |  ||| ||| | | || |||   | | |    || | ||| || ||  ||| | |   || ||  ||| b++-+-+-+---+++-+-+++--+++--+++-+----+-+++------++++++-/   |
| |||||  | |   | || |  ||| ||| | | || |||   | b-+----++-+-+++-++-++--++/ | |   || ||  |||  || | | |   ||| | |||  |||  ||| |    | |||      ||||||     |
| |||||  | |   | || |  ||| ||| | | || |||   |   |    || | ||| || ||  ||  | |   || ||  |||  || | | |   ||| | |||  |||  ||| |    | |||      ||||||     |
| |||||  | |   | || |  ||| |v| | | || |||  /+---+----++-+-+++-++-++--++--+-+---++-++--+++--++-+-+-+---+++-+-+++--+++--+++-+b   | |||      ||||||     |
| |||||  b-+---+-++-+--+++-+++-+-+-++-+++--++---+----++-+-+++-++-++--++--/ |   || ||  |||  || | | |   ||| | |||  |||  ||| ||   | |||      ||||||     |
| |||||    |   | || |  ||| ||| | | || |||  |b---+----++-+-+++-++-++--++----+---++-++--+++--++-+-+-+---+++-+-+++--+++--+++-++---+-+++------++/|||     |
| |||||    |   | || |  ||| ||| | | || |||  |    |    || | ||| || ||  ||/---+---++-++--+++--++b| | |   ||| | |||  |||  ||| ||   | |||      || |||     |
b-+++++----+---+-++-+--+++-+++-+-+-++-+++--+----+----++-+-+++-++-++--+++---+---++-++--+++--++++-+-+---/|| | |||/-+++--+++-++---+-+++------++-+++b    |
  |||||    |   | || |  ||| |||/+-+-++-+++--+----+--b || | ||| || ||  |||   |   |b-++--+++--++++-+-+----++-+-++++-+++--/|| ||   | |||      || ||||    |
  |||b+----+---+-++-+--+++-+++++-+-++-+++--+----+--+-++-+-+++-++-+/  |||   |   |  ||  |||  |||| | |    || | |||| |||   || ||   | |||      || ||||    |
  ||| |    |   | || | /+++-+++++-+-++-+++--+----+--+-++-+-+++-++-+---+++---+---+-b||  |||  |||| | |    || | |||| |||   || ||   | |||      || ||||    |
  ||| |    |   | || | |||| ||||| | || |||  |    |/-+-++-+-+++-++-+---+++---+---+-+++--+++--++++-+-+----++-+-++++-+++---++-++--b| |||      || ||||    |
  ||| |    b---+-++-/ ||b+-+++++-+-++-+/|  |    || | |b-+-+++-++-+---+++---+---+-+++--+++--++++-+-+----++-+-++++-+++---++-++--++-+++------++-+/||    |
/-+++-+--------+-++-b || | ||||| | || | |  |    || |/+--+-+++-++-+---+++---+<--+b|||/-+++--++++-+-+----++-+-++++-+++---++-++--++-+++b     || | ||    |
| ||| |        | || | || | ||||| | |b-+-+--+----++-+++--+-+++-++-+---+++---+---++++++-+++--++++-+-+----++-+-++++-++/   || ||  || ||||     || | ||    |
| ||| |        | || | || | ||b++-+-+--+-+--+----++-+++--+-+++-++-+---+/|   |   |||||| |||  |||| | |    || | |||| ||    || ||  || ||||     || | ||    |
| ||| |        | || | || | || |b-+-+--+-+--+----++-+++--+-+++-++-+---+-+---+---++++++-+++--++++-+-+----++-+-++++-/|    || ||  || ||||     || | ||    |
| ||| |        | || | || | || |  | |  | |  |    || ||| /+-+++-++-+---+-+---+---++++++-+++--++++-+-+--b || | ||||  |    || ||  || ||||     || | ||    |
| ||| |        | || | || b-++-+--+-+--+-+--+----++-+++-++-+++-++-+---+-+---+---++++++-+++--++++-+-+--+-++-+-++++--+----++-++--+/ ||||     || | ||    |
| ||| |        | || | ||   || |  | |  | |  |    || ||b-++-+++-++-+---+-+---+---++++++-+++--++++-+-+--+-++-+-++++--+----++-++--+--++++-->--++-+-++----/
|/+++-+-------b| || | ||   || |  | b--+-+--+----++-++--++-+++-++-+---+-+---+---++++++-+++--++++-+-+--+-++-+-++++--+----++-++--+--++++-----++-/ ||     
||||| |       || |b-+-++---++-+--+----+-+--+----++-++--++-+++-++-+---+-+---+---++++++-+++--++++-+-+--+-++-/ ||||  |    || ||  |  ||||     ||   ||     
||||| |       || |  | ||   || |  |    | |  |    || ||  || ||| || |   | |   |   |||||| |||  |||| | |  | ||   ||||  |    || ||  |  ||||     ||   ||     
||||| |       || |  | ||   || |  |    | |  |    || ||  || ||| || |   | b---+---++++++-+++--++/| | |  | ||   ||||  |    || ||  |  ||||     ||   ||     
||||| |       || |  | ||   || |  | /--+-+>-+----++-++--++-+++-++-+---+-----+---++++++-+++--++-+-+-+--+-++---++++--+----++-++--+--++++---b ||   ||     
||||| |       || |  | ||   || |  | |/-+-+--+----++b||  || ||| || |   |     |   |||||| |||  || | | |  | ||/--++++<-+----++-++--+--++++---+-++---++---b 
||||| |       || |  | ||   || | /+-++-+-+--+----+++++--++-+++-++-+---+-----+---++++++b|||  || | | |  | |||  ||||  |    || ||  |  ||||   | ||   ||   | 
||||| |       || | /+-++---++-+-++-++-+-+--+-b  |||||  || ||| || |   |     |   ||||||||||  || | | |  | |||  ||||  |    ||/++--+--++++---+-++--b||   | 
||||| |       || | || ||/--++-+-++b|| |/+--+-+--+++++--++-+++-++-+---+-b   |   ||||||||||  || | | |  | |||  ||||  |    |||||  |  ||||   | ||  |||   | 
||||| |       || | || |b+--++-+-+++++-+++--+-+--+++++--++-+++-++-+---+-+---+---++++++++++--++-+-+-+--+-+++--/|||  |    |||||  |  ||||   | |^  |||   | 
|||b+-+-------++-+-++-+-+--++-+-+++++-+++--+-+--+++++--++-+++-/| |   | |   |/--++++++++++--++-+-+-+--+-+++---+++--+----+++++--+--++++---+-++-b|||   | 
||| | |       || | || | |  ||/+-+++++-+++--+-+--+++++--++-+++--+-+---+-+---++--++++++++++b || | | |  | |||   ||b--+----+++++--+--++++---+-++-+++/   | 
||| | |       || | || | |  |||| ||||| b++--+-+--+++++--++-+++--+-+---+-+---++--+++++++++++-++-+-+-+--+-+++---++---+----+++++--+--++++---+-++-++/    | 
||| | |       || | || | |  |||| |||||  ||  | |  |||||  |b-+++--+-+---+-+---++--++++++++/|| || | |/+--+-+++---++---+----+++++--+--++++-b | || ||     | 
||| | |       || | || | |  |||| |||||  ||  | |  |||||  |  |||  | |   | |   ||  |||||||| || || | |||  | |b+---++---/    |||||  |  |||| | | || ||     | 
||| | |       || | || | |  |||| |||||  ||  | |  |||||  |  |||  | |   | |   ||  |||||||| || || | |||  | | |   ||        b++++--+--+/|| | | || ||     | 
||| | |       || | || | |  |||| |||||  |b--+-+--+++++--+--+++--+-+---+-+---++--++++++++-++-++-+-+++--+-+-+---+/         ||||  |  | || | | || ||     | 
||| | |       || | || | |  |||| |||||  |   v |  ||||b--+--+++--+-+---+-+---++--+/|||||| || || | ||b--+-+-+---+----------++++--+--/ || | | || ||     | 
||| | |       || | || | |  |||| |||||  |   | |  ||||   |  |||  | |   | |   ||  | |||||| || || | ||   | | |/--+-----b    ||b+--+----++-+-+-+/ ||     | 
||| | |       || | || | |  |||b-+++++--+---+-+--+++/   |  |||  | |   | |   ||  | |||||| || || | ||   | | ||  |     |    || |  |    || | | |  ||     | 
||| | |       || | || | |  |||  |||||  |   | |  |||    |  |||  | |   | |   ||  | |||b++-++-++-+-++---+-+-++--+-----+----++-+--+----+/ | | |  ||     | 
||| | |       || | || | |  |||  ||||| /+---+-+--+++----+--+++--+-+---+-+---++-b| ||| || || || | ||   | | ||  |     |    || |  |    |  | | |  ||     | 
||| | |       || | || | |  ||b--+++++-++---+-+--+++----+--+++--+-+---+-+---++-++-+++-++-+/ || | |b---+-+-++--+-----+----++-+--+----+--/ | |  ||     | 
||| | |       || | || | |  ||   |b+++-++---+-+--+++----+--+++--+-+---+-+---++-++-++/ || |  || | |    | | ||  |     |    || |  |    |    | |  ||     | 
||| | b-------++-+-++-+-+--++---+-+++-++---+-+--+++----+--+++--+-+---+-+---++-++-++--++-+--++-/ |    | | ||  |     |    |b-+--+----+----+-+--+/     | 
||| |         |b-+-++-+-+--++---+-+++-++---+-+--+++----+--+++--+-/   | |   || || |b--++-+--+/   |    | | ||  |     |    |  |  |    |    | |  |      | 
||| |         |  | || | |  ||   | ||| ||   | |  |||    |  |||  |     | |   || || |   || |  b----+----+-+-++--+-----+----/  |  |    |    | |  |      | 
||| |         |  | || | |  ||   | ||| ||   | |  |||    |  |||  |     | |   || || |   || |      /+----+-+-++--+-----+-------+--+----+--b | |  |      | 
||| |  /------+--+-++-+-+--++---+-+++-++---+-+--+++----+--+++--+-----+-+---++-++-+---++-+------++----+-+-++--+-b   |       |  |    |  | | |  |      | 
||| |  |      |  | || | |  |b---+-+++-++---+-+--+++----+--+++--+-----+-+---++-++-+---+/ |      ||    | | ||  | |   |       |  |    |  | | |  |      | 
||| |  |      |  | || | |  |    | ||| ||   | |  |||    |  |||  |     | |   || || |   |  |      ||    | | b+--+-+---+-------+--+----+--+-+-+--+------/ 
||| |  |      |  | || | |  |    | ||| ||   | |  |||    |  |||  |     | |   || || |   |  |      ||    | |  |  | |   |       |  |    |  | | |  |        
||| |  |      |  | || | |  |    | ||| ||   | |  |||    |  |||  |     b-+---++-++-+---+--+------++----+-/  |  | |   |       |  |    |  | | |  |        
||| |  |      |  | || | |  |    | ||| ||   | |  |||    |  |||  |       |   || || |   |  |      |b----+<---+--+-+---+-------+--+----/  | | |  |        
|b+-+--+------/  | || | |  |    | ||| ||   | |  |||    |  |||  |       |   || || | /-+--+------+-----+----+b | |   |       |  |       | | |  |        
| | |  |         | || | |  |    | ||| ||   | |  |||    |  |||  |       |   || || | | |  |      |     |    || | |   |       |  |       | | |  |        
| | |  |         | || | |  |    | ||| ||   | |  |||    |  |||  |       |   |b-++-+-+-+--+------+-----+----++-+-+---+-------+--+-------+-+-+--/        
| | |  |         | || | |  |    | ||| ||   | |  |||    b--+++--+-------+---+--++-+-+-+--+------+-----/    || | |   |       |  |       | | |           
| | |  |         | || | |  b----+-+++-++---+-+--+++-------+++--/       |   b--++-+-+-+--+------+----------++-/ |   |       |  |       | | |           
b-+-+--+---------+-+/ | |       | |b+-++---+-+--+++-------+++----------+------++-+-+-+--+------+----------++---+---+-------+--+-------+-/ |           
  | |  |         | |  | b-------+-/ | |b---+-+--+++-------+++----------/      || | | |  |      b----------++---+---+-------+--+-------/   |           
  | |  |         | |  |         |   | b----+-+--+++-------+++-----------------/| | | |  |                 ||   |   |      /+--+---------b |           
  | |  |         | b--+---------+---+------+-//-+++-------+++------------------+-+-+-+--+-----------------++---+---+------++--+---------+b|           
  | |  |         |    |         |   |      |  | |||       |||                  | | | |  |                 ||   |   |      ||  |         |||           
  | b--+---------+----+---------+---+------+--+-+++-------+/|                  | | | |  |                 b+---+---/      ||  |         |||           
  |    |         |    |         |   |      |  | |v|       | |                  | | | |  |                  |   |          ||  |         |||           
  |    |         b----+---------+---+------+--+-+++-------/ |                  | | | |  |                  |   |          ||  |         |||           
  |    |              |         |   |      b--+-+++---------+------------------+-+-+-+--+------------------+---+----------+/  |         |||           
  |    |              |         |   |         | |b+---------+------------------+-+-+-+--+------------------+---+----------+---/         |||           
  |    |              |         |   b---------+-+-/         b------------------+-+-+-+--+------------------+---+----------+-------------++/           
  |    |              |         b-------------+-+------------------------------+-+-+-/  |                  |   |          |             ||            
  b----+--------------+-----------------------+-/                              | | b----+------------------/   |          |             ||            
       b--------------+-----------------------+--------------------------------+-+------+----------------------/          |             ||            
                      b-----------------------+--------------------------------+-/      |                                 |             ||            
                                              b--------------------------------+--------+---------------------------------+-------------+/            
                                                                               b--------/                                 b-------------/             
"""
let testInput = """
/->-b        
|   |  /----b
| /-+--+-b  |
| | |  | v  |
b-+-/  b-+--/
  b------/   
"""
let lines = input.split(separator: "\n")

enum Location {
    case horizontal, vertical, slashCorner, backSlashCorner, intersection, empty
    
    func toString() -> String {
        switch self {
        case .horizontal:
            return "-"
        case .vertical:
            return "|"
        case .slashCorner:
            return "/"
        case .backSlashCorner:
            return "\\"
        case .intersection:
            return "+"
        case .empty:
            return " "
        }
    }
}
enum TurnDirection: Int, CaseIterable {
    case left = 0, straight, right
}
enum MoveDirection: Int, CaseIterable {
    case up = 0, left, down, right
}

class Cart {
    var x: Int
    var y: Int
    var nextTurn: TurnDirection
    var points: MoveDirection
    
    init( x: Int, y: Int, points: MoveDirection ) {
        self.x = x
        self.y = y
        self.points = points
        self.nextTurn = .left
    }
    
    func intersectionTurn() -> Void {
        let newDirection = points.rawValue - nextTurn.rawValue + 1 + MoveDirection.allCases.count
        let adjustedDirection = newDirection % MoveDirection.allCases.count
        let newTurn = ( nextTurn.rawValue + 1 ) % TurnDirection.allCases.count
        
        points = MoveDirection( rawValue: adjustedDirection )!
        nextTurn = TurnDirection( rawValue: newTurn )!
    }
    
    func slashTurn() -> Void {
        points = MoveDirection( rawValue: points.rawValue ^ 3 )!
    }
    
    func backSlashTurn() -> Void {
        points = MoveDirection( rawValue: points.rawValue ^ 1 )!
    }
    
    func move() -> ( Int, Int ) {
        var newx = x
        var newy = y
        
        switch points {
        case .up, .down:
            newy += points.rawValue - 1
        case .left, .right:
            newx += points.rawValue - 2
        }
        
        return ( newx, newy )
    }
}

var cave: [[Location]] = []
var carts: [Cart] = []

func printLayout() -> Void {
    for row in cave {
        print( row.map { $0.toString() }.joined() )
    }
}

for line in lines {
    var row: [Location] = []
    
    for char in line {
        switch char {
        case "/":
            row.append(.slashCorner)
        case "b":
            row.append(.backSlashCorner)
        case "-":
            row.append(.horizontal)
        case "|":
            row.append(.vertical)
        case "+":
            row.append(.intersection)
        case " ":
            row.append(.empty)
        case "^":
            carts.append( Cart( x: row.count, y: cave.count, points: .up ) )
            row.append(.vertical)
        case "v":
            carts.append( Cart( x: row.count, y: cave.count, points: .down ) )
            row.append(.vertical)
        case "<":
            carts.append( Cart( x: row.count, y: cave.count, points: .left ) )
            row.append(.horizontal)
        case ">":
            carts.append( Cart( x: row.count, y: cave.count, points: .right ) )
            row.append(.horizontal)
        default:
            print( "Bad input: '\(char)'" )
        }
    }
    cave.append(row)
}

//printLayout()

var crashCount = 0

while carts.count > 1 {
//    carts.forEach { print( "Cart at \($0.x),\($0.y) \($0.points)" ) }
    for ( index, cart ) in carts.enumerated() {
        var newx = cart.x
        var newy = cart.y
        
        switch cave[cart.y][cart.x] {
        case .horizontal:
            switch cart.points {
            case .left, .right:
                newx = cart.move().0
            default:
                print( "Sideways at \(cart.x),\(cart.y)" )
            }
        case .vertical:
            switch cart.points {
            case .up, .down:
                newy = cart.move().1
            default:
                print( "Sideways at \(cart.x),\(cart.y)" )
            }
        case .slashCorner:
            cart.slashTurn()
            ( newx, newy ) = cart.move()
        case .backSlashCorner:
            cart.backSlashTurn()
            ( newx, newy ) = cart.move()
        case .intersection:
            cart.intersectionTurn()
            ( newx, newy ) = cart.move()
        default:
            print( "Off the rails at \(cart.x),\(cart.y)" )
        }
        
        ///TODO: detect crash before actual move.
        if !carts.contains( where: { $0.x == newx && $0.y == newy } ) {
            cart.x = newx
            cart.y = newy
        } else {
            if crashCount == 0 {
                print( "Part1:", "\(newx),\(newy)" )
            }
            crashCount += 1
            carts.remove(at: index)
            carts.removeAll( where: { $0.x == newx && $0.y == newy } )
        }
    }
    
    carts.sort( by: { $0.y < $1.y || $0.y == $1.y && $0.x < $1.x } )
}

print( "Part3:", "\(carts[0].x),\(carts[0].y)" )
